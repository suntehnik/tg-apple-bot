# Руководство по тестированию анализа изображений еды

Это руководство описывает, как тестировать функционал анализа изображений еды с использованием OpenAI Vision API.

## Подготовка тестовых изображений

Для тестирования анализа изображений еды используются изображения в формате JPG, расположенные в директории `tests/img/`:

- `pizza.jpg` - изображение пиццы
- `salad.jpg` - изображение салата
- `burger.jpg` - изображение бургера

### Добавление реальных изображений

Для полноценного тестирования с реальными изображениями:

1. Найдите или создайте изображения еды (пицца, салат, бургер)
2. Сохраните их в формате JPG в директории `tests/img/` с соответствующими именами
3. Убедитесь, что изображения имеют разумный размер (рекомендуется до 1 МБ)

## Запуск тестов

### Быстрый тест с моковыми ответами

Для проверки функциональности без использования настоящего API:

```bash
python run_openai_test.py
```

Этот скрипт не требует ключа API и использует предустановленные моковые ответы для тестовых изображений.

### Интеграционный тест

Для более полного тестирования:

```bash
python tests/integration_test_openai.py
```

Этот тест будет использовать настоящий OpenAI API, если доступен ключ API, или моковые ответы в противном случае.

### Использование настоящего OpenAI API

Для тестирования с настоящим API:

1. Получите ключ API от OpenAI
2. Установите переменную окружения `OPENAI_API_KEY`:

```bash
export OPENAI_API_KEY=your_api_key
python tests/integration_test_openai.py
```

### Использование моковых ответов в основном приложении

Для принудительного использования моковых ответов в основном приложении:

```bash
export USE_MOCK_OPENAI=true
python app.py
```

## Добавление новых типов еды для тестирования

Чтобы добавить новый тип еды для тестирования:

1. Создайте изображение в формате JPG
2. Сохраните его в директории `tests/img/` с информативным именем
3. Добавьте моковый ответ в методе `mock_analyze_food_image` в `core/services/openai.py`:

```python
elif "new_food" in image_name:
    return {
        "success": True,
        "food_name": "New Food Name",
        "calories": 123,
        "proteins": 45,
        "fats": 67,
        "carbs": 89
    }
```

4. При необходимости обновите тестовые сценарии

## Тестирование в CI/CD

В CI/CD тесты запускаются с моковыми ответами для экономии ресурсов и обеспечения стабильности. Для этого:

1. Не устанавливайте переменную окружения `OPENAI_API_KEY` в CI/CD
2. Используйте команду `python tests/integration_test_openai.py` для запуска тестов

## Советы по отладке

- Проверьте, что файлы изображений существуют и доступны для чтения
- Включите подробное логирование с помощью переменной окружения `LOG_LEVEL=DEBUG`
- При использовании настоящего API проверьте лимиты и ограничения OpenAI
- Для анализа результатов используйте файлы в директории `logs/`

## Форматирование изображений

Если у вас есть изображения в другом формате (например, PNG), вы можете конвертировать их в JPG:

```bash
# С использованием ImageMagick
convert image.png image.jpg

# С использованием Python и библиотеки Pillow
python -c "from PIL import Image; Image.open('image.png').convert('RGB').save('image.jpg', 'JPEG')"
```